<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Space Math Blaster - Core Edition</title>
    <style>
        body {
            margin: 0;
            padding: 0;
            background: linear-gradient(to bottom, #0a0a2e, #16213e, #1a1a3a);
            overflow: hidden;
            font-family: 'Inter', 'Arial', sans-serif;
            color: white;
            display: flex;
            align-items: center;
            justify-content: center;
            min-height: 100vh;
            position: relative; 
        }
        
        canvas {
            display: block;
            background: radial-gradient(circle at 20% 80%, #120458 0%, transparent 50%),
                        radial-gradient(circle at 80% 20%, #2c1810 0%, transparent 50%),
                        radial-gradient(circle at 40% 40%, #0a0a2e 0%, transparent 50%);
            width: 100%;
            height: 100%;
        }
        
        .game-ui-container {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            pointer-events: none; 
            display: none; 
            flex-direction: column;
            align-items: center;
        }

        .pause-button {
            position: absolute;
            top: 20px;
            left: 20px;
            font-size: clamp(24px, 4vw, 30px); 
            background-color: rgba(0, 120, 150, 0.7);
            color: #00ffff;
            border: 2px solid #00ffff;
            border-radius: 8px;
            padding: 5px 12px; 
            cursor: pointer;
            pointer-events: all; 
            z-index: 15; 
            box-shadow: 0 0 10px rgba(0, 255, 255, 0.5);
            transition: background-color 0.2s, transform 0.1s;
        }

        .pause-button:hover {
            background-color: rgba(0, 150, 180, 0.9);
            transform: scale(1.1);
        }
        
        .problem {
            margin-top: 30px;
            font-size: clamp(24px, 5vw, 36px);
            font-weight: bold;
            text-shadow: 0 0 10px #00ffff, 0 0 20px #00ffff;
            color: #00ffff;
            text-align: center;
        }
        
        .score-container { 
            position: absolute;
            top: 20px;
            right: 30px;
            display: flex;
            flex-direction: column;
            align-items: flex-end;
        }
        .score {
            font-size: clamp(18px, 4vw, 24px);
            color: #ffff00;
            text-shadow: 0 0 5px #ffff00;
        }
        .shields-display {
            font-size: clamp(14px, 3vw, 18px);
            color: #00ff00; 
            text-shadow: 0 0 3px #00ff00;
            margin-top: 5px;
        }
        
        .instructions {
            position: absolute;
            bottom: 20px;
            left: 50%;
            transform: translateX(-50%);
            text-align: center;
            font-size: clamp(12px, 2.5vw, 14px);
            color: #aaa;
            width: 90%;
        }

        .screen {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(10, 10, 46, 0.97); 
            display: none; 
            flex-direction: column;
            align-items: center;
            justify-content: center;
            text-align: center;
            z-index: 10; 
            padding: 20px;
            box-sizing: border-box;
            overflow-y: auto;
        }
        .screen h1 {
            font-size: clamp(30px, 7vw, 52px);
            color: #00ffff;
            text-shadow: 0 0 10px #00ffff, 0 0 20px #00ffff;
            margin-bottom: 30px;
        }
        .screen h2 { 
            font-size: clamp(26px, 6vw, 44px);
            color: #ffff00;
            text-shadow: 0 0 8px #ffff00;
            margin-bottom: 15px; 
        }
        .screen button {
            background-color: #0077cc; 
            color: white;
            border: 2px solid #00ffff; 
            padding: 12px 25px;
            font-size: clamp(16px, 3.5vw, 22px);
            font-weight: bold;
            border-radius: 10px; 
            cursor: pointer;
            margin: 10px;
            transition: background-color 0.2s, transform 0.1s, box-shadow 0.2s;
            box-shadow: 0 4px 15px rgba(0, 200, 255, 0.3); 
            min-width: 180px;
            pointer-events: all; 
        }
        .screen button:hover {
            background-color: #0099e6; 
            transform: translateY(-2px) scale(1.03); 
            box-shadow: 0 6px 20px rgba(0, 255, 255, 0.5);
        }
        .screen button.danger-button { 
            background-color: #cc0000;
            border-color: #ff4444;
            box-shadow: 0 4px 15px rgba(255, 0, 0, 0.3);
        }
        .screen button.danger-button:hover {
            background-color: #e60000;
            box-shadow: 0 6px 20px rgba(255, 50, 50, 0.5);
        }

        .screen > p { 
            font-size: clamp(16px, 3vw, 20px);
            margin-bottom: 20px;
        }

        .level-category-title {
            font-size: clamp(18px, 4vw, 24px);
            color: #ff8c00; 
            margin-top: 20px;
            margin-bottom: 10px;
            text-shadow: 0 0 5px #ff8c00;
        }

        #levelSelectMenu .level-buttons-container {
            display: flex;
            flex-wrap: wrap;
            justify-content: center;
            gap: 12px;
            max-width: 800px; 
            margin-bottom: 15px;
        }
        #levelSelectMenu .level-buttons-container button {
            padding: 10px 15px;
            min-width: 55px; 
            font-size: clamp(14px, 3vw, 18px);
        }
         #levelSelectMenu .core-level-button { 
            min-width: 200px !important; 
            padding: 12px 20px !important;
            font-size: clamp(15px, 3.2vw, 20px) !important;
        }

        .report-container {
            background-color: rgba(0, 0, 0, 0.4); padding: 15px; border-radius: 8px;
            margin-top: 10px; margin-bottom: 15px; max-width: 90%; width: 600px; 
            min-height: 150px; max-height: 350px; border: 1px solid #00ffff66; 
            color: #e0e0e0; text-align: left; box-shadow: 0 0 15px rgba(0, 255, 255, 0.2);
            display: flex; flex-direction: column; 
        }
        .report-container h3 { 
            color: #ffff00; margin-top: 0; margin-bottom: 10px;
            font-size: clamp(17px, 3.2vw, 20px); border-bottom: 1px solid #00ffff44;
            padding-bottom: 8px; flex-shrink: 0; 
        }
        .report-content-scrollable { flex-grow: 1; overflow-y: auto; padding-right: 10px; }
        .report-container p { margin-bottom: 10px; line-height: 1.6; font-size: clamp(15px, 2.8vw, 18px); }
        .report-container p.final-score-report { font-weight: bold; color: #00ff00; margin-bottom: 15px; }
        
        .stats-table { width: 100%; border-collapse: collapse; margin-top: 0; }
        .stats-table th, .stats-table td {
            border: 1px solid #00ffff88; padding: 8px 10px; text-align: left;
            font-size: clamp(13px, 2.5vw, 16px); word-break: break-word; 
        }
        .stats-table th {
            background-color: rgba(0, 80, 120, 0.6); color: #ffff00;
            position: sticky; top: 0; z-index: 1; 
        }
        .stats-table td:nth-child(1) { width: 50%; }
        .stats-table td:nth-child(2), .stats-table td:nth-child(3) { text-align: center; width: 25%; }

        .heatmap-container {
            display: grid; grid-template-columns: repeat(13, 1fr); gap: 2px; padding: 10px;
            background-color: rgba(0,0,0,0.2); border-radius: 8px; max-width: 90vw; margin: 20px auto;
        }
        .heatmap-cell, .heatmap-header {
            aspect-ratio: 1 / 1; display: flex; align-items: center; justify-content: center;
            font-size: clamp(10px, 1.5vw, 14px); font-weight: bold;
            border: 1px solid #003344; border-radius: 4px; color: white;
        }
        .heatmap-header { background-color: rgba(0, 80, 120, 0.5); color: #ffff00; }
        .heatmap-cell { background-color: #444; cursor: default; transition: transform 0.1s ease-in-out; }
        .heatmap-cell:hover { transform: scale(1.1); z-index: 2; }

        .modal-overlay {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background-color: rgba(0,0,0,0.7); display: none; align-items: center;
            justify-content: center; z-index: 1000;
        }
        .modal-content {
            background-color: #1a2a4a; padding: 25px; border-radius: 10px;
            border: 2px solid #00ffff; text-align: center;
            box-shadow: 0 5px 25px rgba(0, 200, 255, 0.4);
            max-width: 90%; width: 400px;
        }
        .modal-content p { font-size: clamp(16px, 3vw, 18px); margin-bottom: 20px; color: #eee; }
        .modal-buttons button { min-width: 120px; margin: 5px 10px; }

        #mainMenu, #levelSelectMenu, #levelCompleteScreen, #gameOverScreen, #pauseMenuScreen,
        #reportingMenuScreen, #heatmapReportScreen, #settingsScreen, #confirmationModal { 
            display: none;
        }
    </style>
</head>
<body>
    <canvas id="gameCanvas"></canvas>
    
    <div class="game-ui-container" id="gameUiContainer">
        <button id="pauseGameBtn" class="pause-button">☰</button>
        <div class="problem" id="problem">? × ? = ?</div>
        <div class="score-container">
            <div class="score" id="score">Score: 0</div>
            <div classs="shields-display" id="shieldsDisplay"></div>
        </div>
        <div class="instructions">
            Move: ←→ keys or mouse | Shoot: SPACEBAR or click/tap
        </div>
    </div>

    <div id="mainMenu" class="screen">
        <h1>Space Math Blaster</h1>
        <button id="selectLevelBtn">Select Level</button>
        <button id="reportingBtn">Reporting</button> 
        <button id="mainMenuSettingsBtn">Settings</button>
    </div>
    
    <div id="settingsScreen" class="screen">
        <h2>Settings</h2>
        <button id="clearHistoryBtn" class="danger-button">Clear Player History</button>
        <div id="clearHistoryStatus" style="margin-top: 10px; color: #00ff00;"></div>
        <button id="backToMainMenuFromSettingsBtn">Back to Main Menu</button>
    </div>

    <div id="confirmationModal" class="modal-overlay">
        <div class="modal-content">
            <p id="confirmationMessageText">Are you sure?</p>
            <div class="modal-buttons">
                <button id="confirmClearBtn" class="danger-button">Confirm</button>
                <button id="cancelClearBtn">Cancel</button>
            </div>
        </div>
    </div>

    <div id="reportingMenuScreen" class="screen">
        <h2>Reporting</h2>
        <button id="overallPerformanceBtn">Overall Performance</button>
        <button id="backToMainMenuFromReportingBtn">Back to Main Menu</button>
    </div>

    <div id="heatmapReportScreen" class="screen">
        <h2>Overall Performance Heatmap</h2>
        <div id="heatmapContainer" class="heatmap-container"></div>
        <button id="backToReportingMenuBtn">Back to Reporting Menu</button>
    </div>

    <div id="levelSelectMenu" class="screen">
        <h2>Select Your Challenge</h2>
        <div class="level-category-title">Practice Levels (Times Tables)</div>
        <div class="level-buttons-container" id="practiceLevelsContainer"></div>
        <div class="level-category-title">Core Gameplay</div>
        <div class="level-buttons-container" id="coreLevelsContainer"></div>
        <button id="backToMainMenuBtnLvl">Back to Main Menu</button>
    </div>

    <div id="pauseMenuScreen" class="screen">
        <h2>Paused</h2>
        <button id="resumeGameBtn">Resume Game</button>
        <button id="pauseMenuSettingsBtn">Settings (WIP)</button>
        <button id="exitToMainMenuBtn">Exit to Main Menu</button>
    </div>

    <div id="levelCompleteScreen" class="screen">
        <h2>Level Complete!</h2>
        <div id="levelReportComplete" class="report-container">
            <h3>Level Performance</h3>
            <div class="report-content-scrollable">
                <p id="finalScoreComplete" class="final-score-report">Your Score: 0</p>
            </div>
        </div>
        <button id="nextLevelBtn">Next Level</button>
        <button id="mainMenuFromCompleteBtn">Main Menu</button>
    </div>

    <div id="gameOverScreen" class="screen">
        <h2>Game Over!</h2>
        <div id="gameOverReport" class="report-container">
            <h3>Game Analysis</h3>
            <div class="report-content-scrollable">
                <p id="finalScoreGameOver" class="final-score-report">Your Score: 0</p>
            </div>
        </div>
        <button id="tryAgainBtn">Try Again</button>
        <button id="mainMenuFromGameOverBtn">Main Menu</button>
    </div>

    <script>
        // DOM Elements
        const canvas = document.getElementById('gameCanvas');
        const ctx = canvas.getContext('2d');
        const gameUiContainer = document.getElementById('gameUiContainer');
        const problemEl = document.getElementById('problem');
        const scoreEl = document.getElementById('score'); 
        const shieldsDisplayEl = document.getElementById('shieldsDisplay');

        const mainMenuScreen = document.getElementById('mainMenu');
        const levelSelectScreen = document.getElementById('levelSelectMenu');
        const practiceLevelsContainer = document.getElementById('practiceLevelsContainer');
        const coreLevelsContainer = document.getElementById('coreLevelsContainer');
        const levelCompleteScreen = document.getElementById('levelCompleteScreen');
        const gameOverScreen = document.getElementById('gameOverScreen');
        const pauseMenuScreen = document.getElementById('pauseMenuScreen'); 
        const reportingMenuScreen = document.getElementById('reportingMenuScreen');
        const heatmapReportScreen = document.getElementById('heatmapReportScreen');
        const heatmapContainer = document.getElementById('heatmapContainer');
        const settingsScreen = document.getElementById('settingsScreen'); 
        const confirmationModal = document.getElementById('confirmationModal'); 
        const confirmationMessageText = document.getElementById('confirmationMessageText'); 
        const clearHistoryStatusEl = document.getElementById('clearHistoryStatus'); 

        const selectLevelBtn = document.getElementById('selectLevelBtn');
        const reportingBtn = document.getElementById('reportingBtn'); 
        const mainMenuSettingsBtn = document.getElementById('mainMenuSettingsBtn');
        const backToMainMenuBtnLvl = document.getElementById('backToMainMenuBtnLvl');
        const nextLevelBtn = document.getElementById('nextLevelBtn');
        const mainMenuFromCompleteBtn = document.getElementById('mainMenuFromCompleteBtn');
        const tryAgainBtn = document.getElementById('tryAgainBtn');
        const mainMenuFromGameOverBtn = document.getElementById('mainMenuFromGameOverBtn');
        
        const pauseGameBtn = document.getElementById('pauseGameBtn'); 
        const resumeGameBtn = document.getElementById('resumeGameBtn'); 
        const pauseMenuSettingsBtn = document.getElementById('pauseMenuSettingsBtn'); 
        const exitToMainMenuBtn = document.getElementById('exitToMainMenuBtn'); 
        
        const overallPerformanceBtn = document.getElementById('overallPerformanceBtn');
        const backToMainMenuFromReportingBtn = document.getElementById('backToMainMenuFromReportingBtn');
        const backToReportingMenuBtn = document.getElementById('backToReportingMenuBtn');
        const clearHistoryBtn = document.getElementById('clearHistoryBtn'); 
        const confirmClearBtn = document.getElementById('confirmClearBtn'); 
        const cancelClearBtn = document.getElementById('cancelClearBtn'); 
        const backToMainMenuFromSettingsBtn = document.getElementById('backToMainMenuFromSettingsBtn'); 
        
        const finalScoreCompleteEl = document.getElementById('finalScoreComplete');
        const finalScoreGameOverEl = document.getElementById('finalScoreGameOver');

        // Game States
        const GAME_STATE = {
            MENU: 'MENU', LEVEL_SELECT: 'LEVEL_SELECT', PLAYING: 'PLAYING',
            LEVEL_COMPLETE: 'LEVEL_COMPLETE', GAME_OVER: 'GAME_OVER', PAUSED: 'PAUSED',
            REPORTING_MENU: 'REPORTING_MENU', HEATMAP_REPORT: 'HEATMAP_REPORT', SETTINGS: 'SETTINGS'
        };
        let currentGameState = GAME_STATE.MENU;
        let previousGameState = GAME_STATE.MENU; 
        let selectedLevelType = null; 
        let selectedLevelValue = null; 

        // Performance Tracking
        let levelProblemStats = {}; 
        let overallPlayerStats = {}; 
        const PLAYER_STATS_KEY = 'spaceMathBlasterOverallStats';

        // Sprite Manager
        const spriteManager = {
            spriteSheetImage: null, isLoaded: false, isLoading: false,
            spriteData: { 
                spaceship:      { sX: 4,   sY: 4,   sWidth: 80,  sHeight: 60,  dWidth: 80,  dHeight: 60  },
                playerBullet:   { sX: 88,  sY: 4,   sWidth: 20,  sHeight: 20,  dWidth: 20,  dHeight: 20  },
                enemy1:         { sX: 116, sY: 4,   sWidth: 80,  sHeight: 60,  dWidth: 80,  dHeight: 60  },
                enemyBullet:    { sX: 204, sY: 4,   sWidth: 16,  sHeight: 16,  dWidth: 16,  dHeight: 16  },
                answerBox:      { sX: 4,   sY: 72,  sWidth: 140, sHeight: 80,  dWidth: 140, dHeight: 80  },
                powerupShield:  { sX: 148, sY: 72,  sWidth: 60,  sHeight: 60,  dWidth: 60,  dHeight: 60  },
                powerupBomb:    { sX: 216, sY: 72,  sWidth: 60,  sHeight: 60,  dWidth: 60,  dHeight: 60  },
                powerupSparkle: { sX: 284, sY: 72,  sWidth: 60,  sHeight: 60,  dWidth: 60,  dHeight: 60  }
            },
            loadSpriteSheet: function(url) {
                if (this.isLoading || this.isLoaded) return; this.isLoading = true;
                this.spriteSheetImage = new Image();
                this.spriteSheetImage.onload = () => { this.isLoaded = true; this.isLoading = false; console.log("Sprite sheet loaded successfully."); };
                this.spriteSheetImage.onerror = () => { this.isLoaded = false; this.isLoading = false; console.error("Failed to load sprite sheet from:", url); };
                this.spriteSheetImage.src = url;
            },
            getSprite: function(name) { if (!this.isLoaded || !this.spriteData[name]) return null; return this.spriteData[name];}
        };

        // Game Variables
        let score = 0; 
        const SCORE_TO_WIN = 200; const SCORE_TO_LOSE = -20; 
        const POINTS_CORRECT_ANSWER = 10; const POINTS_ENEMY_DESTROYED = 5;
        const PENALTY_WRONG_ANSWER = -5; const PENALTY_MISSED_CORRECT = -5; const PENALTY_PLAYER_HIT = -10;

        let spaceship = { x: 0, y: 0, width: spriteManager.spriteData.spaceship.dWidth, height: spriteManager.spriteData.spaceship.dHeight, dx: 0, acceleration: 0.5, maxSpeed: 7, friction: 0.92, shields: 0, isInvincible: false, invincibilityTimer: 0, spriteName: 'spaceship' };
        let bullets = []; let answers = []; let enemies = []; let enemyBullets = []; let powerups = []; let particles = []; 
        let keys = {}; let mouseX = 0; let mouseActive = false;
        const stars = []; const numStars = 150;
        const ANSWER_TRAVEL_TIME_SECONDS = 10; 
        let questionsAnsweredCorrectlyInLevel = 0;
        const POWERUP_SPAWN_INTERVAL = 3; 
        const POWERUP_TYPES = { ANSWER_BOMB: 'ANSWER_BOMB', SHIELD: 'SHIELD', SPARKLE_BOMB: 'SPARKLE_BOMB' };
        let currentProblem = {}; 
        let gameJustReset = false; // Flag to help with initial update cycle

        // --- Stats Helper Functions ---
        function getCanonicalProblemString(num1, num2) {
            return num1 <= num2 ? `${num1} × ${num2}` : `${num2} × ${num1}`;
        }

        function loadOverallStats() {
            const statsJson = localStorage.getItem(PLAYER_STATS_KEY);
            if (statsJson) { overallPlayerStats = JSON.parse(statsJson); } 
            else { overallPlayerStats = {}; }
        }

        function saveOverallStats() { localStorage.setItem(PLAYER_STATS_KEY, JSON.stringify(overallPlayerStats)); }

        function updateOverallStats() {
            for (const problemKey in levelProblemStats) { 
                if (!overallPlayerStats[problemKey]) {
                    overallPlayerStats[problemKey] = { successes: 0, failures: 0 };
                }
                overallPlayerStats[problemKey].successes += levelProblemStats[problemKey].successes;
                overallPlayerStats[problemKey].failures += levelProblemStats[problemKey].failures;
            }
            saveOverallStats();
        }
        
        function clearAllGameEntitiesAndTimers() {
            // This function is a safeguard to clear active game elements
            // when transitioning to a non-gameplay state like MENU or SETTINGS.
            bullets = [];
            answers = [];
            enemies = [];
            enemyBullets = [];
            powerups = [];
            particles = [];
            // If there were any setTimeout or setInterval timers related to game logic,
            // they would be cleared here. Currently, we use requestAnimationFrame,
            // and the game logic is guarded by currentGameState checks in update().
        }


        function setGameState(newState) {
            previousGameState = currentGameState; 
            currentGameState = newState;
            gameJustReset = false; // Reset this flag on any state change

            mainMenuScreen.style.display='none'; levelSelectScreen.style.display='none';
            levelCompleteScreen.style.display='none'; gameOverScreen.style.display='none';
            pauseMenuScreen.style.display='none'; gameUiContainer.style.display='none'; 
            reportingMenuScreen.style.display='none'; heatmapReportScreen.style.display='none';
            settingsScreen.style.display='none'; confirmationModal.style.display='none'; 
            canvas.style.display='block'; 

            switch (newState) {
                case GAME_STATE.MENU: 
                    mainMenuScreen.style.display = 'flex'; 
                    if (previousGameState === GAME_STATE.PLAYING || previousGameState === GAME_STATE.LEVEL_COMPLETE || previousGameState === GAME_STATE.GAME_OVER) {
                        clearAllGameEntitiesAndTimers(); // Clear entities when returning to main menu
                    }
                    break;
                case GAME_STATE.LEVEL_SELECT: levelSelectScreen.style.display = 'flex'; break;
                case GAME_STATE.PLAYING:
                    gameUiContainer.style.display='flex'; 
                    if(previousGameState!==GAME_STATE.PAUSED) {
                        resetGameForNewLevel(); 
                        gameJustReset = true; // Mark that a reset just happened
                    }
                    break;
                case GAME_STATE.PAUSED: pauseMenuScreen.style.display='flex'; gameUiContainer.style.display='flex'; break;
                case GAME_STATE.LEVEL_COMPLETE:
                    finalScoreCompleteEl.textContent=`Your Final Score: ${score}`; 
                    updateOverallStats(); 
                    displayLevelReport('levelReportComplete'); 
                    levelCompleteScreen.style.display='flex'; 
                    break;
                case GAME_STATE.GAME_OVER:
                    finalScoreGameOverEl.textContent=`Your Final Score: ${score}`; 
                    updateOverallStats(); 
                    displayLevelReport('gameOverReport'); 
                    gameOverScreen.style.display='flex'; 
                    break;
                case GAME_STATE.REPORTING_MENU: reportingMenuScreen.style.display = 'flex'; break;
                case GAME_STATE.HEATMAP_REPORT: displayOverallHeatmap(); heatmapReportScreen.style.display = 'flex'; break;
                case GAME_STATE.SETTINGS: settingsScreen.style.display = 'flex'; clearHistoryStatusEl.textContent = ''; break; 
            }
        }
        
        function resetGameForNewLevel() {
            console.log("Resetting game for new level. Previous score:", score); // Debug log
            score=0; 
            scoreEl.textContent=`Score: ${score}`; 
            questionsAnsweredCorrectlyInLevel=0; 
            levelProblemStats={}; 
            
            clearAllGameEntitiesAndTimers(); // Use the new clearing function

            const shipSpr=spriteManager.getSprite('spaceship')||{dWidth:80,dHeight:60}; 
            spaceship.width=shipSpr.dWidth; spaceship.height=shipSpr.dHeight;
            spaceship.x=canvas.width/2; spaceship.y=canvas.height-(shipSpr.dHeight+20); 
            spaceship.dx=0; spaceship.shields=0; spaceship.isInvincible=false; spaceship.invincibilityTimer=0;
            updateShieldsDisplay(); mouseX=spaceship.x; keys={}; 
            generateProblem(); 
            console.log("Game reset complete. New score:", score); // Debug log
        }

        function resizeCanvas() {
            canvas.width=window.innerWidth; canvas.height=window.innerHeight;
            const shipSpr=spriteManager.getSprite('spaceship')||{dWidth:80,dHeight:60}; 
            if(currentGameState===GAME_STATE.PLAYING||(currentGameState!==GAME_STATE.MENU&&currentGameState!==GAME_STATE.LEVEL_SELECT&&spaceship.y===0)){ 
                 spaceship.x=canvas.width/2; spaceship.y=canvas.height-(shipSpr.dHeight+20);
                 spaceship.dx=0; if(answers.length===0 && currentGameState === GAME_STATE.PLAYING)generateProblem(); // Only generate if actively playing and no answers
            }else if(currentGameState===GAME_STATE.MENU||currentGameState===GAME_STATE.LEVEL_SELECT){
                spaceship.y=canvas.height-(shipSpr.dHeight+20); 
            }
            stars.length=0; for(let i=0;i<numStars;i++)stars.push({x:Math.random()*canvas.width,y:Math.random()*canvas.height,size:Math.random()*2+0.5,speed:Math.random()*0.5+0.1,opacity:Math.random()*0.5+0.3});
        }
        
        function checkOverlap(r1,r2){if(!r1||!r2||typeof r1.x==='undefined'||typeof r1.y==='undefined'||typeof r1.width==='undefined'||typeof r1.height==='undefined'||typeof r2.x==='undefined'||typeof r2.y==='undefined'||typeof r2.width==='undefined'||typeof r2.height==='undefined')return false;const r1L=r1.x-r1.width/2,r1R=r1.x+r1.width/2,r1T=r1.y-r1.height/2,r1B=r1.y+r1.height/2;const r2L=r2.x-r2.width/2,r2R=r2.x+r2.width/2,r2T=r2.y-r2.height/2,r2B=r2.y+r2.height/2;return!(r1R<r2L||r1L>r2R||r1B<r2T||r1T>r2B);}

        function generateProblem() {
            let a,b;
            if(selectedLevelType==='PRACTICE'){a=selectedLevelValue;b=Math.floor(Math.random()*12)+1;if(Math.random()<0.5)[a,b]=[b,a];} 
            else if(selectedLevelType==='APPRENTICE'){a=Math.floor(Math.random()*6)+1;b=Math.floor(Math.random()*6)+1;} 
            else if(selectedLevelType==='JOURNEYMAN'){a=Math.floor(Math.random()*9)+1;b=Math.floor(Math.random()*9)+1;} 
            else if(selectedLevelType==='MASTER'){a=Math.floor(Math.random()*12)+1;b=Math.floor(Math.random()*12)+1;} 
            else{a=Math.floor(Math.random()*10)+1;b=Math.floor(Math.random()*10)+1;}
            const correctAnsVal=a*b;currentProblem={a,b,answer:correctAnsVal};problemEl.textContent=`${a} × ${b} = ?`;
            answers=[];const usedAnsVals=new Set([correctAnsVal]);
            const ansSpr=spriteManager.getSprite('answerBox')||{dWidth:140,dHeight:80};const ansW=ansSpr.dWidth,ansH=ansSpr.dHeight;
            const ansVy=(canvas.height+ansH)/(ANSWER_TRAVEL_TIME_SECONDS*60);let placedCorrect=false;
            for(let att=0;att<50&&!placedCorrect;att++){const newA={value:correctAnsVal,x:Math.random()*(canvas.width-ansW-20)+(ansW/2)+10,y:0-ansH/2-(Math.random()*40),vy:ansVy,width:ansW,height:ansH,correct:true,spriteName:'answerBox'};if(!answers.some(ex=>checkOverlap(newA,ex))){answers.push(newA);placedCorrect=true;}}
            if(!placedCorrect)answers.push({value:correctAnsVal,x:canvas.width/2,y:0-ansH/2,vy:ansVy,width:ansW,height:ansH,correct:true,spriteName:'answerBox'});
            const numDist=selectedLevelType==='APPRENTICE'?3:(selectedLevelType==='JOURNEYMAN'?4:5);
            for(let i=0;i<numDist;i++){let wrongV;for(let vA=0;vA<20;vA++){const off=(Math.random()<0.5?-1:1)*(Math.floor(Math.random()*5)+1);wrongV=correctAnsVal+off*(Math.random()<0.3?b:(Math.random()<0.6?a:(Math.floor(Math.random()*5)+1)));if(wrongV<=0||wrongV>144)wrongV=Math.floor(Math.random()*((selectedLevelType==='MASTER'||selectedLevelType==='JOURNEYMAN')?144:(selectedLevelType==='APPRENTICE'?36:100)))+1;if(!usedAnsVals.has(wrongV))break;}
            if(usedAnsVals.has(wrongV))continue;usedAnsVals.add(wrongV);for(let pA=0;pA<30;pA++){const newD={value:wrongV,x:Math.random()*(canvas.width-ansW-20)+(ansW/2)+10,y:0-ansH/2-(Math.random()*140),vy:ansVy,width:ansW,height:ansH,correct:false,spriteName:'answerBox'};if(!answers.some(ex=>checkOverlap(newD,ex))){answers.push(newD);break;}}}
            spawnEnemies();if((selectedLevelType==='JOURNEYMAN'||selectedLevelType==='MASTER')&&(questionsAnsweredCorrectlyInLevel>0&&questionsAnsweredCorrectlyInLevel%POWERUP_SPAWN_INTERVAL===0))spawnPowerup();
        }

        function spawnEnemies(){enemies=[];const enS=spriteManager.getSprite('enemy1')||{dWidth:80,dHeight:60};const enW=enS.dWidth,enH=enS.dHeight;const enVy=(canvas.height+enH)/((ANSWER_TRAVEL_TIME_SECONDS+2)*60);let numE=0,fR=3000,cT=false;if(selectedLevelType==='APPRENTICE'){numE=1;fR=3000;}else if(selectedLevelType==='JOURNEYMAN'){numE=2;fR=2000;}else if(selectedLevelType==='MASTER'){numE=2;fR=2000;cT=true;}
        for(let i=0;i<numE;i++){let pl=false;for(let att=0;att<20&&!pl;att++){const nE={x:Math.random()*(canvas.width-enW-20)+(enW/2)+10,y:0-enH/2-(Math.random()*200),width:enW,height:enH,vy:enVy,fireRate:fR,lastFiredTime:Date.now()+Math.random()*fR,canTarget:cT,health:1,spriteName:'enemy1'};if(!(answers.some(ans=>checkOverlap(nE,ans))||enemies.some(e=>checkOverlap(nE,e)))){enemies.push(nE);pl=true;}}}} // Corrected enemy spawning y to be centered
        
        function spawnPowerup(){if(powerups.length>0)return;const pTypes=Object.values(POWERUP_TYPES);const type=pTypes[Math.floor(Math.random()*pTypes.length)];let sN='',iTxt='';if(type===POWERUP_TYPES.SHIELD){sN='powerupShield';iTxt='S🛡️';}else if(type===POWERUP_TYPES.ANSWER_BOMB){sN='powerupBomb';iTxt='B💣';}else if(type===POWERUP_TYPES.SPARKLE_BOMB){sN='powerupSparkle';iTxt='✨';}
        const pS=spriteManager.getSprite(sN)||{dWidth:60,dHeight:60};const pSize=pS.dWidth;const pVy=(canvas.height+pSize)/((ANSWER_TRAVEL_TIME_SECONDS-2)*60);powerups.push({x:Math.random()*(canvas.width-pSize-20)+(pSize/2)+10,y:0-pSize/2,width:pSize,height:pSize,vy:pVy,type:type,acquired:false,spriteName:sN,iconText:iTxt});}

        function drawSpaceship(){const spr=spriteManager.getSprite(spaceship.spriteName);if(spr&&spriteManager.isLoaded&&spriteManager.spriteSheetImage){if(spaceship.isInvincible&&Math.floor(Date.now()/100)%2===0)return;ctx.drawImage(spriteManager.spriteSheetImage,spr.sX,spr.sY,spr.sWidth,spr.sHeight,spaceship.x-spr.dWidth/2,spaceship.y-spr.dHeight/2,spr.dWidth,spr.dHeight);}else{if(spaceship.isInvincible&&Math.floor(Date.now()/100)%2===0)return;ctx.fillStyle='#00ffff';ctx.beginPath();ctx.moveTo(spaceship.x,spaceship.y-spaceship.height/2);ctx.lineTo(spaceship.x-spaceship.width/2,spaceship.y+spaceship.height/2);ctx.lineTo(spaceship.x+spaceship.width/2,spaceship.y+spaceship.height/2);ctx.closePath();ctx.fill();const eGH=10+Math.random()*5;ctx.fillStyle='#ff4400';ctx.fillRect(spaceship.x-4,spaceship.y+spaceship.height/2,8,eGH);ctx.fillStyle='#ffff00';ctx.fillRect(spaceship.x-2,spaceship.y+spaceship.height/2,4,eGH-2);}}
        function drawBullets(bArr,defSprName){bArr.forEach(b=>{const spr=spriteManager.getSprite(b.spriteName||defSprName);if(spr&&spriteManager.isLoaded&&spriteManager.spriteSheetImage){ctx.drawImage(spriteManager.spriteSheetImage,spr.sX,spr.sY,spr.sWidth,spr.sHeight,b.x-spr.dWidth/2,b.y-spr.dHeight/2,spr.dWidth,spr.dHeight);}else{const clr=(b.spriteName==='enemyBullet')?'#FF6347':'#ffff00';const rad=(b.spriteName==='enemyBullet')?8:10;ctx.fillStyle=b.color||clr;ctx.beginPath();ctx.arc(b.x,b.y,b.width/2||rad,0,Math.PI*2);ctx.fill();ctx.shadowColor=b.color||clr;ctx.shadowBlur=8;ctx.fill();ctx.shadowBlur=0;}});}
        function drawRoundedRect(c,x,y,w,h,r){c.beginPath();c.moveTo(x+r,y);c.lineTo(x+w-r,y);c.quadraticCurveTo(x+w,y,x+w,y+r);c.lineTo(x+w,y+h-r);c.quadraticCurveTo(x+w,y+h,x+w-r,y+h);c.lineTo(x+r,y+h);c.quadraticCurveTo(x,y+h,x,y+h-r);c.lineTo(x,y+r);c.quadraticCurveTo(x,y,x+r,y);c.closePath();}
        function drawAnswers(){answers.forEach(ans=>{const spr=spriteManager.getSprite(ans.spriteName);const dX=ans.x-ans.width/2,dY=ans.y-ans.height/2;if(spr&&spriteManager.isLoaded&&spriteManager.spriteSheetImage)ctx.drawImage(spriteManager.spriteSheetImage,spr.sX,spr.sY,spr.sWidth,spr.sHeight,dX,dY,ans.width,ans.height);else{ctx.fillStyle='rgba(0,100,255,0.7)';ctx.strokeStyle='#00ffff';ctx.lineWidth=2;drawRoundedRect(ctx,dX,dY,ans.width,ans.height,8);ctx.fill();ctx.stroke();}
        ctx.fillStyle='white';ctx.font='bold 24px Inter,Arial';ctx.textAlign='center';ctx.textBaseline='middle';ctx.fillText(ans.value,ans.x,ans.y);});}
        function drawEnemies(){enemies.forEach(en=>{const spr=spriteManager.getSprite(en.spriteName);if(spr&&spriteManager.isLoaded&&spriteManager.spriteSheetImage)ctx.drawImage(spriteManager.spriteSheetImage,spr.sX,spr.sY,spr.sWidth,spr.sHeight,en.x-spr.dWidth/2,en.y-spr.dHeight/2,spr.dWidth,spr.dHeight);else{ctx.fillStyle=en.color||'#FF6347';ctx.beginPath();ctx.moveTo(en.x,en.y+en.height/2);ctx.lineTo(en.x-en.width/2,en.y-en.height/2);ctx.lineTo(en.x+en.width/2,en.y-en.height/2);ctx.closePath();ctx.fill();}});}
        function drawPowerups(){powerups.forEach(p=>{if(!p.acquired){const spr=spriteManager.getSprite(p.spriteName);if(spr&&spriteManager.isLoaded&&spriteManager.spriteSheetImage)ctx.drawImage(spriteManager.spriteSheetImage,spr.sX,spr.sY,spr.sWidth,spr.sHeight,p.x-spr.dWidth/2,p.y-spr.dHeight/2,spr.dWidth,spr.dHeight);else{ctx.fillStyle=p.type===POWERUP_TYPES.SHIELD?'rgba(0,255,0,0.7)':p.type===POWERUP_TYPES.ANSWER_BOMB?'rgba(255,165,0,0.7)':'rgba(255,255,0,0.7)';ctx.strokeStyle='#FFFFFF';ctx.lineWidth=2;drawRoundedRect(ctx,p.x-p.width/2,p.y-p.height/2,p.width,p.height,5);ctx.fill();ctx.stroke();ctx.fillStyle='black';ctx.font='bold 20px Inter,Arial';ctx.textAlign='center';ctx.textBaseline='middle';ctx.fillText(p.iconText,p.x,p.y);}}});}
        function drawParticles(){particles.forEach(p=>{ctx.fillStyle=p.color;ctx.beginPath();ctx.arc(p.x,p.y,p.size,0,Math.PI*2);ctx.fill();});}
        function drawStars(){stars.forEach(s=>{ctx.fillStyle='white';s.opacity+=(Math.random()-0.5)*0.1;s.opacity=Math.max(0.2,Math.min(1,s.opacity));ctx.globalAlpha=s.opacity;ctx.beginPath();ctx.arc(s.x,s.y,s.size,0,Math.PI*2);ctx.fill();});ctx.globalAlpha=1;}
        function updateShieldsDisplay(){shieldsDisplayEl.textContent=spaceship.shields>0?`Shields: ${'🛡️'.repeat(spaceship.shields)}`:"";}
        function activatePowerup(p){p.acquired=true;powerups=powerups.filter(pw=>pw!==p);if(p.type===POWERUP_TYPES.ANSWER_BOMB)answers=answers.filter(ans=>ans.correct);else if(p.type===POWERUP_TYPES.SHIELD){spaceship.shields=2;updateShieldsDisplay();}else if(p.type===POWERUP_TYPES.SPARKLE_BOMB)for(let i=0;i<100;i++)particles.push({x:Math.random()*canvas.width,y:Math.random()*canvas.height,size:Math.random()*3+1,color:`rgba(255,255,${Math.floor(Math.random()*155)+100},${Math.random()*0.5+0.5})`,life:60+Math.random()*60,vx:(Math.random()-0.5)*4,vy:(Math.random()-0.5)*4});}
        function updateParticles(){for(let i=particles.length-1;i>=0;i--){const p=particles[i];p.x+=p.vx;p.y+=p.vy;p.life--;if(p.life<=0)particles.splice(i,1);}}

        function update() {
            if (currentGameState !== GAME_STATE.PLAYING) { // Simplified guard for active gameplay
                if (currentGameState === GAME_STATE.PAUSED) { // Only animate stars/particles if paused
                    stars.forEach(s=>{s.y+=s.speed*0.5;if(s.y>canvas.height+s.size){s.y=-s.size;s.x=Math.random()*canvas.width;}});
                    updateParticles();
                }
                return; 
            }
            if (gameJustReset) { // Skip one update cycle after reset to allow canvas to clear and objects to settle
                gameJustReset = false;
                return;
            }


            stars.forEach(s=>{s.y+=s.speed;if(s.y>canvas.height+s.size){s.y=-s.size;s.x=Math.random()*canvas.width;}});updateParticles();if(spaceship.isInvincible){spaceship.invincibilityTimer-=1000/60;if(spaceship.invincibilityTimer<=0)spaceship.isInvincible=false;}
            let mL=keys['ArrowLeft'],mR=keys['ArrowRight'];if(mL)spaceship.dx-=spaceship.acceleration;if(mR)spaceship.dx+=spaceship.acceleration;if(!mL&&!mR)spaceship.dx*=spaceship.friction;if(Math.abs(spaceship.dx)<0.1&&!mL&&!mR)spaceship.dx=0;if(spaceship.dx>spaceship.maxSpeed)spaceship.dx=spaceship.maxSpeed;if(spaceship.dx<-spaceship.maxSpeed)spaceship.dx=-spaceship.maxSpeed;spaceship.x+=spaceship.dx;if(spaceship.x-spaceship.width/2<0){spaceship.x=spaceship.width/2;spaceship.dx=0;}if(spaceship.x+spaceship.width/2>canvas.width){spaceship.x=canvas.width-spaceship.width/2;spaceship.dx=0;}
            if(mouseActive){spaceship.x=mouseX;spaceship.dx=0;if(spaceship.x<spaceship.width/2)spaceship.x=spaceship.width/2;if(spaceship.x>canvas.width-spaceship.width/2)spaceship.x=canvas.width-spaceship.width/2;mouseActive=false;}
            bullets=bullets.filter(b=>{b.y-=b.speed;return b.y>-b.height/2;});enemyBullets=enemyBullets.filter(eb=>{eb.y+=eb.vy;eb.x+=eb.vx;return eb.y<canvas.height+eb.height/2&&eb.y>-eb.height/2&&eb.x>-eb.width/2&&eb.x<canvas.width+eb.width/2;});
            
            let correctAnsMissedThisProblem=false;
            for(let i=answers.length-1;i>=0;i--){
                const ans=answers[i];ans.y+=ans.vy;
                if(ans.y-ans.height/2>canvas.height){
                    if(ans.correct && !correctAnsMissedThisProblem){ // Only penalize once per problem if its correct answer is missed
                        score+=PENALTY_MISSED_CORRECT;scoreEl.textContent=`Score: ${score}`;
                        correctAnsMissedThisProblem=true; 
                        if(score<=SCORE_TO_LOSE){setGameState(GAME_STATE.GAME_OVER); return;} // Early exit if game over
                    }
                    answers.splice(i,1);
                }
            }
            if(correctAnsMissedThisProblem && answers.filter(a=>a.correct).length===0 && currentGameState === GAME_STATE.PLAYING){ // If correct missed AND no correct left
                 generateProblem(); // Generate new problem
            }

            const curT=Date.now();for(let i=enemies.length-1;i>=0;i--){const en=enemies[i];en.y+=en.vy;if(en.y-en.height/2>canvas.height){enemies.splice(i,1);continue;}
            if(curT>en.lastFiredTime+en.fireRate){en.lastFiredTime=curT;let bVx=0,bVy=5;if(en.canTarget){const ang=Math.atan2((spaceship.y-spaceship.height/2)-(en.y-en.height/2),spaceship.x-en.x);bVx=Math.cos(ang)*bVy;bVy=Math.sin(ang)*bVy;if(bVy<2)bVy=2;}
            const ebS=spriteManager.getSprite('enemyBullet')||{dWidth:16,dHeight:16};enemyBullets.push({x:en.x,y:en.y+en.height/2,vx:bVx,vy:bVy,width:ebS.dWidth,height:ebS.dHeight,spriteName:'enemyBullet'});}}
            for(let i=powerups.length-1;i>=0;i--){const p=powerups[i];if(!p.acquired){p.y+=p.vy;if(p.y-p.height/2>canvas.height)powerups.splice(i,1);}}
            
            for(let i=bullets.length-1;i>=0;i--){
                const b=bullets[i]; let bulletDestroyedThisLoop=false;
                for(let j=answers.length-1;j>=0;j--){
                    if(bulletDestroyedThisLoop) break;
                    const ans=answers[j];
                    if(checkOverlap(b,ans)){
                        const pStr=getCanonicalProblemString(currentProblem.a,currentProblem.b);
                        if(!levelProblemStats[pStr])levelProblemStats[pStr]={successes:0,failures:0};
                        bullets.splice(i,1);bulletDestroyedThisLoop=true;
                        if(ans.correct){
                            score+=POINTS_CORRECT_ANSWER;questionsAnsweredCorrectlyInLevel++;levelProblemStats[pStr].successes++;
                            if(score>=SCORE_TO_WIN){setGameState(GAME_STATE.LEVEL_COMPLETE); return;} // Early exit
                            else generateProblem();
                        }else{
                            score+=PENALTY_WRONG_ANSWER;levelProblemStats[pStr].failures++;answers.splice(j,1);
                            if(!answers.some(a=>a.correct) && currentGameState === GAME_STATE.PLAYING){ if(score>SCORE_TO_LOSE)generateProblem();}
                        }
                        scoreEl.textContent=`Score: ${score}`;
                        if(score<=SCORE_TO_LOSE && currentGameState === GAME_STATE.PLAYING){setGameState(GAME_STATE.GAME_OVER); return;} // Early exit
                        break; 
                    }
                }
                if(bulletDestroyedThisLoop)continue;
                for(let k=enemies.length-1;k>=0;k--){
                    if(bulletDestroyedThisLoop) break;
                    const en=enemies[k];
                    if(checkOverlap(b,en)){
                        bullets.splice(i,1);bulletDestroyedThisLoop=true;en.health--;
                        if(en.health<=0){enemies.splice(k,1);score+=POINTS_ENEMY_DESTROYED;scoreEl.textContent=`Score: ${score}`;}
                        break;
                    }
                }
                if(bulletDestroyedThisLoop)continue;
                for(let l=powerups.length-1;l>=0;l--){
                    if(bulletDestroyedThisLoop) break;
                    const pwr=powerups[l];
                    if(!pwr.acquired&&checkOverlap(b,pwr)){bullets.splice(i,1);bulletDestroyedThisLoop=true;activatePowerup(pwr);break;}
                }
            }

            if(!spaceship.isInvincible){
                for(let i=enemyBullets.length-1;i>=0;i--){
                    const eb=enemyBullets[i];
                    if(checkOverlap(eb,spaceship)){
                        enemyBullets.splice(i,1); score += PENALTY_PLAYER_HIT; scoreEl.textContent = `Score: ${score}`; // Apply penalty
                        if(spaceship.shields>0){spaceship.shields--;updateShieldsDisplay();spaceship.isInvincible=true;spaceship.invincibilityTimer=1000;}
                        else{setGameState(GAME_STATE.GAME_OVER); return;} // Early exit
                        break;
                    }
                }
                if (currentGameState !== GAME_STATE.PLAYING) return; // Check state again after potential game over

                for(let i=enemies.length-1;i>=0;i--){
                    const en=enemies[i];
                    if(checkOverlap(en,spaceship)){
                        score += PENALTY_PLAYER_HIT; scoreEl.textContent = `Score: ${score}`; // Apply penalty
                        if(spaceship.shields>0){spaceship.shields--;updateShieldsDisplay();spaceship.isInvincible=true;spaceship.invincibilityTimer=1500;enemies.splice(i,1);}
                        else{setGameState(GAME_STATE.GAME_OVER); return;} // Early exit
                        break;
                    }
                }
            }
             if (currentGameState === GAME_STATE.PLAYING && score <= SCORE_TO_LOSE) { // Final check for score based game over
                setGameState(GAME_STATE.GAME_OVER);
            }
        }

        function render(){ctx.clearRect(0,0,canvas.width,canvas.height);drawStars();drawParticles();if(currentGameState===GAME_STATE.PLAYING||currentGameState===GAME_STATE.PAUSED){drawAnswers();drawEnemies();drawPowerups();drawSpaceship();drawBullets(bullets,'playerBullet');drawBullets(enemyBullets,'enemyBullet');}}
        function gameLoop(){ update(); render(); requestAnimationFrame(gameLoop); }
        function shoot(){if(currentGameState!==GAME_STATE.PLAYING)return;const bS=spriteManager.getSprite('playerBullet')||{dWidth:20,dHeight:20};bullets.push({x:spaceship.x,y:spaceship.y-spaceship.height/2,width:bS.dWidth,height:bS.dHeight,speed:10,spriteName:'playerBullet'});}
        function nextLevelSelection(){if(selectedLevelType=="PRACTICE"&&selectedLevelValue<=11)selectedLevelValue+=1;else if(selectedLevelType=="PRACTICE"&&selectedLevelValue==12){selectedLevelType="APPRENTICE";selectedLevelValue=null;}else if(selectedLevelType=="APPRENTICE")selectedLevelType="JOURNEYMAN";else if(selectedLevelType=="JOURNEYMAN")selectedLevelType="MASTER";setGameState(GAME_STATE.PLAYING);}
        
        function displayLevelReport(reportContainerId){
            const rCont=document.getElementById(reportContainerId);if(!rCont)return;const sCont=rCont.querySelector('.report-content-scrollable');if(!sCont)return;const sP=sCont.querySelector('p.final-score-report');sCont.innerHTML='';if(sP)sCont.appendChild(sP);
            if(Object.keys(levelProblemStats).length===0){const noSt=document.createElement('p');noSt.textContent="No problems attempted this level.";sCont.appendChild(noSt);return;}
            let tbl='<table class="stats-table"><thead><tr><th>Problem</th><th>Successes</th><th>Failures</th></tr></thead><tbody>';
            const sortedProbs = Object.keys(levelProblemStats).sort((a,b)=>{const[a1,a2]=a.split(' × ').map(Number);const[b1,b2]=b.split(' × ').map(Number);if(a1!==b1)return a1-b1;return a2-b2;});
            for(const prob of sortedProbs){const st=levelProblemStats[prob];tbl+=`<tr><td>${prob}</td><td>${st.successes}</td><td>${st.failures}</td></tr>`;}
            tbl+='</tbody></table>';sCont.innerHTML+=tbl;
        }

        function displayOverallHeatmap() {
            loadOverallStats(); heatmapContainer.innerHTML=''; const maxSize=12;
            const hRow=document.createElement('div');hRow.className='heatmap-header';heatmapContainer.appendChild(hRow);
            for(let i=1;i<=maxSize;i++){const hCell=document.createElement('div');hCell.className='heatmap-header';hCell.textContent=i;heatmapContainer.appendChild(hCell);}
            for(let i=1;i<=maxSize;i++){const rHCell=document.createElement('div');rHCell.className='heatmap-header';rHCell.textContent=i;heatmapContainer.appendChild(rHCell);
                for(let j=1;j<=maxSize;j++){
                    const uProbStr = `${i} × ${j}`; const canonProbStr = getCanonicalProblemString(i,j);
                    const stats=overallPlayerStats[canonProbStr]||{successes:0,failures:0};
                    const totalAtt=stats.successes+stats.failures;let cColor='hsl(0,0%,26.7%)';let sRate=0;
                    if(totalAtt>0){sRate=stats.successes/totalAtt;if(sRate>=0.9)cColor='hsl(120,100%,45%)';else if(stats.successes===0&&stats.failures>0)cColor='hsl(0,100%,50%)';else{const hue=sRate*120;cColor=`hsl(${hue},100%,50%)`;}}
                    const cell=document.createElement('div');cell.className='heatmap-cell';cell.style.backgroundColor=cColor;
                    cell.textContent=uProbStr; cell.title=`${uProbStr} (Stats for ${canonProbStr}): ${stats.successes}S / ${stats.failures}F`;heatmapContainer.appendChild(cell);
                }
            }
        }

        function setupEventListeners() {
            selectLevelBtn.addEventListener('click',()=>setGameState(GAME_STATE.LEVEL_SELECT));
            reportingBtn.addEventListener('click',()=>setGameState(GAME_STATE.REPORTING_MENU));
            mainMenuSettingsBtn.addEventListener('click',()=>setGameState(GAME_STATE.SETTINGS));
            backToMainMenuBtnLvl.addEventListener('click',()=>setGameState(GAME_STATE.MENU));
            mainMenuFromCompleteBtn.addEventListener('click',()=>setGameState(GAME_STATE.MENU));
            mainMenuFromGameOverBtn.addEventListener('click',()=>setGameState(GAME_STATE.MENU));
            tryAgainBtn.addEventListener('click',()=>setGameState(GAME_STATE.PLAYING));
            nextLevelBtn.addEventListener('click',()=>nextLevelSelection());
            pauseGameBtn.addEventListener('click',()=>{if(currentGameState===GAME_STATE.PLAYING)setGameState(GAME_STATE.PAUSED);});
            resumeGameBtn.addEventListener('click',()=>{if(currentGameState===GAME_STATE.PAUSED)setGameState(GAME_STATE.PLAYING);});
            pauseMenuSettingsBtn.addEventListener('click',()=>alert('Settings (Pause Menu): Coming Soon!'));
            exitToMainMenuBtn.addEventListener('click',()=>setGameState(GAME_STATE.MENU));
            overallPerformanceBtn.addEventListener('click',()=>setGameState(GAME_STATE.HEATMAP_REPORT));
            backToMainMenuFromReportingBtn.addEventListener('click',()=>setGameState(GAME_STATE.MENU));
            backToReportingMenuBtn.addEventListener('click',()=>setGameState(GAME_STATE.REPORTING_MENU));
            
            clearHistoryBtn.addEventListener('click',()=>{confirmationMessageText.textContent="Are you sure you want to clear all player history? This action cannot be undone.";confirmationModal.style.display='flex';});
            confirmClearBtn.addEventListener('click',()=>{overallPlayerStats={};localStorage.removeItem(PLAYER_STATS_KEY);confirmationModal.style.display='none';clearHistoryStatusEl.textContent='Player history cleared!';setTimeout(()=>clearHistoryStatusEl.textContent='',3000);});
            cancelClearBtn.addEventListener('click',()=>{confirmationModal.style.display='none';});
            backToMainMenuFromSettingsBtn.addEventListener('click',()=>setGameState(GAME_STATE.MENU));

            document.addEventListener('keydown',(e)=>{if(currentGameState===GAME_STATE.PLAYING){keys[e.code]=true;if(e.code==='Space'){e.preventDefault();shoot();}}if(e.code==='Escape'){e.preventDefault();if(currentGameState===GAME_STATE.PLAYING)setGameState(GAME_STATE.PAUSED);else if(currentGameState===GAME_STATE.PAUSED)setGameState(GAME_STATE.PLAYING);}});
            document.addEventListener('keyup',(e)=>{if(currentGameState===GAME_STATE.PLAYING)keys[e.code]=false;});
            canvas.addEventListener('mousemove',(e)=>{if(currentGameState===GAME_STATE.PLAYING){const rect=canvas.getBoundingClientRect();mouseX=e.clientX-rect.left;mouseActive=true;}});
            canvas.addEventListener('click',(e)=>{if(currentGameState===GAME_STATE.PLAYING)shoot();});
            window.addEventListener('resize',resizeCanvas);
        }

        function populateLevelSelectMenu(){practiceLevelsContainer.innerHTML='';coreLevelsContainer.innerHTML='';for(let i=1;i<=12;i++){const btn=document.createElement('button');btn.textContent=i;btn.addEventListener('click',()=>{selectedLevelType='PRACTICE';selectedLevelValue=i;setGameState(GAME_STATE.PLAYING);});practiceLevelsContainer.appendChild(btn);}
        const coreLvls=[{name:"Apprentice Blaster",type:'APPRENTICE'},{name:"Journeyman Blaster",type:'JOURNEYMAN'},{name:"Master Blaster",type:'MASTER'}];coreLvls.forEach(lvl=>{const btn=document.createElement('button');btn.textContent=lvl.name;btn.classList.add('core-level-button');btn.addEventListener('click',()=>{selectedLevelType=lvl.type;selectedLevelValue=null;setGameState(GAME_STATE.PLAYING);});coreLevelsContainer.appendChild(btn);});}

        window.onload=()=>{loadOverallStats();resizeCanvas();populateLevelSelectMenu();setupEventListeners();spriteManager.loadSpriteSheet('https://cdn.jsdelivr.net/gh/tnharvey/testRedir@main/Spritesheet.png');setGameState(GAME_STATE.MENU);gameLoop();};
    </script>
</body>
</html>